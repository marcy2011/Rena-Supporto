<!DOCTYPE html>
<html>

<head>
  <title id="page-title">Rena Supporto - Segnala bug</title>
  <link rel="icon" type="image/x-icon" href="icon.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <meta property="og:url" content="renadeveloper.altervista.org">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap">
  <link href="https://api.fontshare.com/v2/css?f[]=open-sauce-one@400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: black;
      color: white;
      font-family: 'Open Sauce One', sans-serif;
      min-height: 100vh;
      cursor: url('cursore.png'), auto;
    }

    .floating-navbar {
      position: fixed;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 50px;
      padding: 15px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 90%;
      max-width: 1000px;
      z-index: 1000;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }

    .floating-navbar:hover {
      background: rgba(0, 0, 0, 0.4);
      transform: translateX(-50%) translateY(-2px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
    }

    .header-brand {
      text-decoration: none;
    }

    .header-brand:hover {
      transform: none;
    }

    .navbar-nav {
      display: flex;
      align-items: center;
      gap: 30px;
      flex: 1;
      justify-content: center;
    }

    .nav-link {
      color: white;
      text-decoration: none;
      font-size: 16px;
      font-weight: 500;
      padding: 8px 16px;
      border-radius: 20px;
      transition: all 0.3s ease;
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
      line-height: 1;
    }

    .nav-link::before {
      display: none;
    }

    .nav-link:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
    }

    .nav-link.active {
      background: rgba(255, 255, 255, 0.2);
      box-shadow: 0 2px 8px rgba(255, 255, 255, 0.2);
    }

    .navbar-account {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-shrink: 0;
    }

    .account-menu {
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: none;
    }

    .menu-icon {
      width: 28px;
      height: 28px;
      transition: none;
      display: block;
    }

    .menu-icon path {
      transition: none;
    }

    .profile-menu-container {
      position: relative;
      z-index: 200;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #profile-button {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
    }

    .profile-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(255, 255, 255, 0.3);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .profile-pic:hover {
      transform: scale(1.1);
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    }

    .default-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      font-weight: 600;
      border: 2px solid rgba(255, 255, 255, 0.3);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .profile-menu {
      display: none;
      position: absolute;
      top: 65px;
      right: -15px;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 15px;
      width: 200px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .profile-menu.active {
      display: block;
      z-index: 1001;
    }

    .profile-menu-item {
      display: flex;
      align-items: center;
      padding: 10px;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.3s ease;
      margin-bottom: 5px;
    }

    .profile-menu-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .profile-menu-item i {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }

    .profile-menu-divider {
      height: 1px;
      background: rgba(255, 255, 255, 0.1);
      margin: 10px 0;
    }

    .language-option {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .language-option:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .language-option.active {
      background: rgba(255, 255, 255, 0.15);
    }

    .language-content {
      display: flex;
      align-items: center;
    }

    .language-flag {
      width: 20px;
      height: 15px;
      margin-right: 10px;
      border-radius: 3px;
    }

    .check-icon {
      width: 16px;
      height: 16px;
      stroke: #4ade80;
      stroke-width: 2;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .language-option.active .check-icon {
      opacity: 1;
    }

    @media screen and (max-width: 768px) {
      .floating-navbar {
        width: 95%;
        padding: 12px 20px;
        top: 20px;
        justify-content: space-between;
      }

      .profile-menu-container {
        order: 1;
        flex-grow: 1;
        display: flex;
        justify-content: flex-start;
        margin-left: -7px;
      }

      .navbar-logo {
        order: 2;
        position: static;
        left: auto;
        transform: none;
        flex-shrink: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-grow: 0;
        height: 100%;
      }

      .navbar-nav {
        display: none;
      }

      .navbar-account {
        order: 3;
        display: flex;
        align-items: center;
        gap: 10px;
        margin-left: 0;
        flex-grow: 1;
        justify-content: flex-end;
      }

      .menu-icon {
        width: 28px;
        height: 28px;
        transform: translateY(-1px) scaleX(-1);
      }

      .profile-menu {
        left: 0 !important;
        right: auto !important;
        transform: none !important;
      }
    }

    @media screen and (min-width: 769px) {
      .floating-navbar {
        top: 30px;
        max-width: 1100px;
      }

      .navbar-nav {
        display: flex;
        order: 2;
      }

      .navbar-logo {
        order: 1;
      }

      .profile-menu-container {
        order: 3;
      }

      .navbar-account {
        display: none;
      }
    }

    @media screen and (max-width: 480px) {
      .floating-navbar {
        padding: 8px 16px;
      }

      .menu-icon {
        width: 24px;
        height: 24px;
      }
    }

    #custom-menu {
      display: none;
      position: absolute;
      background: rgba(0, 0, 0, 0.9);
      border-radius: 15px;
      padding: 15px;
      backdrop-filter: blur(20px);
      z-index: 99999999;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    #custom-menu ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    #custom-menu ul li {
      margin-bottom: 10px;
    }

    #custom-menu ul li a {
      display: flex;
      align-items: center;
      color: #fff;
      text-decoration: none;
      padding: 8px 12px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    #custom-menu ul li a:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateX(5px);
    }

    #custom-menu ul li a img {
      margin-right: 10px;
      border-radius: 5px;
    }

    #custom-menu ul li a span {
      font-size: 16px;
    }

    #custom-menu ul li a.has-svg span {
      margin-left: 10px;
    }

    .custom-menu-svg {
      width: 22px;
      height: 22px;
      max-width: 100%;
      max-height: 100%;
    }

    main {
      padding-top: 120px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    ::selection {
      background-color: white;
      color: black;
    }

    *:focus {
      outline: none;
    }

    * {
      -webkit-tap-highlight-color: transparent;
    }

    iframe {
      border: none;
      border-radius: 20px;
      width: 100%;
      min-height: 130vh;
      height: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    iframe::-webkit-scrollbar {
      display: none;
    }

    .image-destra {
      width: 100%;
      height: auto;
      border-radius: 10px;
    }

    .content-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      margin-top: 20px;
      width: 100%;
      max-width: 800px;
      height: auto;
      margin-left: auto;
      margin-right: auto;
    }

    @media (min-width: 768px) {
      .image-destra {
        position: absolute;
        top: 10%;
        left: 5%;
        width: 554px;
        height: 554px;
      }

      iframe {
        width: 100%;
        min-height: 120vh;
        height: auto;
      }

      .content-section {
        float: right;
        width: 700px;
        height: auto;
        margin-right: 5%;
      }
    }

    @media (max-width: 767px) {
      .content-section {
        margin-top: 0;
        width: 95%;
      }

      iframe {
        width: 100%;
        min-height: 140vh;
        height: auto;
      }
    }

    .login-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .login-popup.active {
      opacity: 1;
      visibility: visible;
    }

    .login-popup-content {
      background: rgba(0, 0, 0, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 30px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .close-popup {
      position: absolute;
      top: 15px;
      right: 15px;
      color: rgba(255, 255, 255, 0.6);
      font-size: 22px;
      cursor: pointer;
      transition: color 0.2s ease;
    }

    .close-popup:hover {
      color: white;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top: 4px solid #fff;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .context-menu-svg {
      width: 22px !important;
      height: 22px !important;
      margin-right: 10px;
    }

    .navbar-logo {
      position: relative;
    }

    .navbar-logo .header-brand {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: block;
    }

    .navbar-logo-img {
      height: 55px;
      display: block;
    }

    @media screen and (min-width: 769px) {
      .navbar-logo-img {
        margin-left: 30px;
      }
    }
  </style>
</head>

<body>
  <nav class="floating-navbar">
    <div class="profile-menu-container">
      <div id="profile-button"></div>
      <div class="profile-menu" id="profile-menu">
        <a href="https://rena.altervista.org/account.php" class="profile-menu-item" id="account-link">
          <i class="fas fa-user"></i>
          <span data-translate-it="Il mio account" data-translate-en="My Account">Il mio account</span>
        </a>
      </div>
    </div>

    <div class="navbar-logo">
      <a class="header-brand" href="https://renasupporto.altervista.org">
        <img src="transparent_icon.png" alt="Rena Supporto" class="navbar-logo-img">
      </a>
    </div>

    <div class="navbar-nav">
      <a href="https://renasupporto.altervista.org" class="nav-link">
        <img src="https://gcsapp.altervista.org/homebanner.png" alt="Home" width="19">
        <span>Home</span>
      </a>
      <a href="https://renasupporto.altervista.org/segnala-bug.html" class="nav-link">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#ffffff" width="23" height="auto">
                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                <g id="SVGRepo_iconCarrier"> 
                  <path d="M6 14.4623H16.1909C17.6066 14.4623 18.472 12.7739 17.7261 11.4671L17.2365 10.6092C16.7547 9.76504 16.7547 8.69728 17.2365 7.85309L17.7261 6.99524C18.472 5.68842 17.6066 4 16.1909 4L6 4L6 14.4623ZM6 14.4623L6 20" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path> 
                </g>
              </svg>
        <span>Segnala Bug</span>
      </a>
    </div>

    <div class="navbar-account">
      <div class="account-menu">
        <a href="https://renasupporto.altervista.org/menu.html">
          <svg class="menu-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
            transform="rotate(0)matrix(-1, 0, 0, 1, 0, 0)" stroke="#ffffff">
            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
            <g id="SVGRepo_iconCarrier">
              <path d="M4 6H20M4 12H14M4 18H9" stroke="#ffffff" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round"></path>
            </g>
          </svg>
        </a>
      </div>
    </div>
  </nav>

  <div id="custom-menu">
    <ul>
      <li><a href="https://renadeveloper.altervista.org"><img src="https://gcsapp.altervista.org/homebanner.png"
            alt="Image 1" width="20"><span>Home</span></a></li>
      <li><a href="https://renasupporto.altervista.org/segnala-bug.html">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#ffffff" width="30" height="30" left="15px;">
                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                <g id="SVGRepo_iconCarrier"> 
                  <path d="M6 14.4623H16.1909C17.6066 14.4623 18.472 12.7739 17.7261 11.4671L17.2365 10.6092C16.7547 9.76504 16.7547 8.69728 17.2365 7.85309L17.7261 6.99524C18.472 5.68842 17.6066 4 16.1909 4L6 4L6 14.4623ZM6 14.4623L6 20" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path> 
                </g>
              </svg><span>Segnala Bug</span></a></li>
    </ul>
  </div>

  <div class="login-popup" id="loginPopup">
    <div class="login-popup-content">
      <span class="close-popup" id="closeLoginPopup">&times;</span>
      <h3 data-translate-it="Accesso in corso..." data-translate-en="Logging in...">Accesso in corso...</h3>
      <p data-translate-it="Stai per essere reindirizzato alla pagina di login di Rena ID"
        data-translate-en="You will be redirected to Rena ID login page">Stai per essere reindirizzato alla pagina di
        login di Rena ID</p>
      <div style="text-align: center; margin-top: 20px;">
        <div class="spinner" style="margin: 0 auto;"></div>
      </div>
    </div>
  </div>

  <div style="margin-top: 85px;">
    <a href="https://t.me/BugRena_bot">
      <img class="image-destra" src="bugseg.png" alt="">
    </a>
    <div class="content-section">
      <iframe id="myIframe" src="https://renasupporto.altervista.org/formbug.html" scrolling="auto"></iframe>
    </div>
  </div>

  <script>
    let isVerifyingToken = false;
    let tokenVerificationInterval = null;
    let accountLink = document.getElementById('account-link');

    document.addEventListener('DOMContentLoaded', function () {
      console.log("DOM completamente caricato");
      loadSavedLanguage();
      handleTokenFromURL();
      setupEventListeners();
      checkLoginStatus();
    });

    function setupEventListeners() {
      console.log("Impostazione event listeners");

      const profileButton = document.getElementById('profile-button');
      const profileMenu = document.getElementById('profile-menu');

      if (profileButton && profileMenu) {
        profileButton.addEventListener('click', function (e) {
          e.stopPropagation();
          profileMenu.classList.toggle('active');
        });

        document.addEventListener('click', function () {
          profileMenu.classList.remove('active');
        });

        profileMenu.addEventListener('click', function (e) {
          e.stopPropagation();
        });
      }

      document.getElementById('closeLoginPopup').addEventListener('click', function () {
        document.getElementById('loginPopup').classList.remove('active');
      });

      document.addEventListener('contextmenu', function (event) {
        event.preventDefault();
        if (window.innerWidth > 768) {
          var customMenu = document.getElementById('custom-menu');
          customMenu.style.display = 'block';
          customMenu.style.left = event.pageX + 'px';
          customMenu.style.top = event.pageY + 'px';
        }
      });

      document.addEventListener('click', function (event) {
        var customMenu = document.getElementById('custom-menu');
        if (customMenu && !customMenu.contains(event.target)) {
          customMenu.style.display = 'none';
        }
      });
    }

    function openCrossDomainLogin() {
      console.log("Apertura login cross-domain");
      document.getElementById('loginPopup').classList.add('active');

      const loginUrl = `https://rena.altervista.org/login.php?external_domain=${encodeURIComponent(window.location.origin)}`;

      const loginWindow = window.open(
        loginUrl,
        'RenaLogin',
        'width=500,height=600,scrollbars=no,resizable=no'
      );

      if (!loginWindow) {
        document.getElementById('loginPopup').classList.remove('active');
        alert('Il browser ha bloccato la popup. Per favore consenti le popup per questo sito.');
        return;
      }

      const checkWindowClosed = setInterval(() => {
        if (loginWindow.closed) {
          clearInterval(checkWindowClosed);
          document.getElementById('loginPopup').classList.remove('active');
          checkLoginStatus();
        }
      }, 500);

      setTimeout(() => {
        if (!loginWindow.closed) {
          loginWindow.close();
          document.getElementById('loginPopup').classList.remove('active');
          alert('Tempo scaduto. Riprova.');
        }
      }, 30000);
    }

    function handleTokenFromURL() {
      console.log("Controllo token dall'URL");
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');
      const user_id = urlParams.get('user_id');
      const username = urlParams.get('username');

      if (token && user_id && username) {
        console.log("Token trovato nell'URL, salvataggio dati utente");
        const userData = {
          status: 'success',
          user_id: user_id,
          username: username,
          token: token,
          lastVerification: Date.now()
        };

        localStorage.setItem('user_data', JSON.stringify(userData));
        updateProfileUI(userData);
        startTokenVerification();
        window.history.replaceState({}, document.title, window.location.pathname);
      } else {
        checkLoginStatus();
      }
    }

    function checkLoginStatus() {
      console.log("Controllo stato login...");
      const savedUserData = localStorage.getItem('user_data');

      if (savedUserData) {
        try {
          const userData = JSON.parse(savedUserData);
          console.log("Dati utente trovati:", userData);

          updateProfileUI(userData);

          if (userData.token && !isVerifyingToken) {
            const now = Date.now();
            const lastVerification = userData.lastVerification || 0;

            if (now - lastVerification > 5000) {
              isVerifyingToken = true;
              console.log("Avvio verifica token dopo ritardo");

              setTimeout(() => {
                verifyToken(userData.token)
                  .then(valid => {
                    console.log("Risultato verifica token:", valid);
                    isVerifyingToken = false;

                    if (!valid) {
                      console.log("Token non valido, tentativo di refresh...");
                      refreshUserData();
                    } else {
                      userData.lastVerification = Date.now();
                      localStorage.setItem('user_data', JSON.stringify(userData));
                    }
                  })
                  .catch(error => {
                    console.error("Errore verifica token:", error);
                    isVerifyingToken = false;
                  });
              }, 1000);
            }
          }
        } catch (e) {
          console.error("Errore parsing dati utente:", e);
          localStorage.removeItem('user_data');
          showLoginUI();
        }
      } else {
        console.log("Nessun dato utente trovato");
        showLoginUI();
      }
    }

    window.addEventListener('message', function (event) {
      console.log("Messaggio ricevuto:", event.data, "da origine:", event.origin);

      const allowedOrigins = [
        'https://rena.altervista.org',
        'https://renadeveloper.altervista.org'
      ];

      if (!allowedOrigins.includes(event.origin)) {
        console.log("Messaggio da origine non autorizzata:", event.origin);
        return;
      }

      if (event.data && event.data.status === 'success') {
        console.log("Login successful, salvataggio dati utente");

        const userData = {
          status: 'success',
          user_id: event.data.user_id,
          username: event.data.username,
          token: event.data.token,
          profile_photo: event.data.profile_photo,
          lastVerification: Date.now()
        };

        localStorage.setItem('user_data', JSON.stringify(userData));

        updateProfileUI(userData);
        startTokenVerification();

        document.getElementById('loginPopup').classList.remove('active');
      }
    });

    function updateProfileUI(data) {
      console.log("Aggiornamento UI profilo con dati:", data);
      const profileButton = document.getElementById('profile-button');

      if (!profileButton) {
        console.error("Pulsante profilo non trovato");
        return;
      }

      profileButton.innerHTML = '';

      if (data && (data.logged_in === true || data.status === 'success' || data.user_id)) {
        const username = data.username || data.user_id || 'Utente';

        if (data.profile_photo) {
          console.log("Tentativo di caricamento foto profilo:", data.profile_photo);
          const img = document.createElement('img');
          img.className = 'profile-pic';
          img.alt = 'Foto profilo';
          img.src = data.profile_photo;

          img.onerror = function () {
            console.log("Errore caricamento foto profilo, uso avatar di default");
            this.remove();
            const defaultAvatar = document.createElement('div');
            defaultAvatar.className = 'default-avatar';
            defaultAvatar.textContent = username.charAt(0).toUpperCase();
            profileButton.appendChild(defaultAvatar);
          };

          img.onload = function () {
            console.log("Foto profilo caricata con successo");
          };

          profileButton.appendChild(img);
        } else {
          console.log("Nessuna foto profilo, uso avatar di default");
          const defaultAvatar = document.createElement('div');
          defaultAvatar.className = 'default-avatar';
          defaultAvatar.textContent = username.charAt(0).toUpperCase();
          profileButton.appendChild(defaultAvatar);
        }

        if (accountLink) {
          accountLink.href = `https://rena.altervista.org/account.php?user_id=${data.user_id}`;
        }

        console.log("UI profilo aggiornata per utente loggato");
      } else {
        console.log("UI profilo impostata per utente non loggato");
        const loginButton = document.createElement('div');
        loginButton.className = 'default-avatar';
        loginButton.innerHTML = '<i class="fas fa-user"></i>';
        loginButton.onclick = openCrossDomainLogin;
        profileButton.appendChild(loginButton);
      }
    }

    function showLoginUI() {
      console.log("Mostro UI login");
      const profileButton = document.getElementById('profile-button');

      if (profileButton) {
        profileButton.innerHTML = '';
        const loginButton = document.createElement('div');
        loginButton.className = 'default-avatar';
        loginButton.innerHTML = '<i class="fas fa-user"></i>';
        loginButton.onclick = openCrossDomainLogin;
        profileButton.appendChild(loginButton);
      }
    }

    async function verifyToken(token) {
      console.log("Verifica token in corso...");
      if (!token) return false;

      try {
        const response = await fetch('https://rena.altervista.org/verify_token.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ token: token })
        });

        console.log("Status risposta:", response.status);
        console.log("Status text:", response.statusText);

        const result = await response.json();
        console.log("Risultato verifica completo:", result);

        return result.valid === true;
      } catch (error) {
        console.error("Errore durante la verifica del token:", error);
        return true;
      }
    }

    function refreshUserData() {
      console.log("Refresh dati utente");
      const savedUserData = localStorage.getItem('user_data');

      if (savedUserData) {
        try {
          const userData = JSON.parse(savedUserData);
          if (userData.token) {
            fetch('https://rena.altervista.org/get_user_data.php', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ token: userData.token })
            })
              .then(response => {
                if (!response.ok) {
                  throw new Error('Network response was not ok');
                }
                return response.json();
              })
              .then(data => {
                if (data.status === 'success') {
                  const updatedUserData = {
                    ...userData,
                    ...data,
                    lastVerification: Date.now()
                  };
                  localStorage.setItem('user_data', JSON.stringify(updatedUserData));
                  updateProfileUI(updatedUserData);
                } else {
                  console.log("Refresh fallito, ma mantengo dati locali");
                }
              })
              .catch(error => {
                console.error("Errore durante l'aggiornamento dei dati utente:", error);
              });
          }
        } catch (e) {
          console.error("Errore parsing dati utente:", e);
        }
      }
    }

    function startTokenVerification() {
      console.log("Avvio verifica periodica token");
      if (tokenVerificationInterval) {
        clearInterval(tokenVerificationInterval);
      }

      tokenVerificationInterval = setInterval(() => {
        const savedUserData = localStorage.getItem('user_data');
        if (savedUserData) {
          try {
            const userData = JSON.parse(savedUserData);
            if (userData.token && !isVerifyingToken) {
              isVerifyingToken = true;
              verifyToken(userData.token)
                .then(valid => {
                  isVerifyingToken = false;
                  if (!valid) {
                    console.log("Token non valido, disconnessione");
                    localStorage.removeItem('user_data');
                    showLoginUI();
                    clearInterval(tokenVerificationInterval);
                  }
                })
                .catch(error => {
                  console.error("Errore verifica token:", error);
                  isVerifyingToken = false;
                });
            }
          } catch (e) {
            console.error("Errore parsing dati utente:", e);
            localStorage.removeItem('user_data');
            showLoginUI();
            clearInterval(tokenVerificationInterval);
          }
        } else {
          clearInterval(tokenVerificationInterval);
        }
      }, 30000);
    }

    function loadSavedLanguage() {
      console.log("Caricamento lingua salvata");
      const savedLang = localStorage.getItem('selectedLanguage') || 'it';
      translatePage(savedLang);
    }

    function translatePage(lang) {
      console.log("Traduzione pagina in", lang);
      localStorage.setItem('selectedLanguage', lang);

      const iframe = document.getElementById('myIframe');
      if (iframe) {
        if (lang === 'en') {
          iframe.src = 'https://renasupporto.altervista.org/formbug.html';
        } else {
          iframe.src = 'https://renasupporto.altervista.org/formbug.html';
        }
      }

      document.querySelectorAll('.language-option').forEach(option => {
        if (option.getAttribute('data-lang') === lang) {
          option.classList.add('active');
        } else {
          option.classList.remove('active');
        }
      });

      document.querySelectorAll('[data-translate-it]').forEach(element => {
        if (lang === 'en') {
          element.textContent = element.getAttribute('data-translate-en');
        } else {
          element.textContent = element.getAttribute('data-translate-it');
        }
      });

      const pageTitle = document.getElementById('page-title');
      if (pageTitle) {
        if (lang === 'en') {
          pageTitle.textContent = 'Rena Supporto - Segnala Bug';
        } else {
          pageTitle.textContent = 'Rena Supporto - Segnala Bug';
        }
      }
    }
  </script>
  <script>
    window.addEventListener('message', function (event) {
      console.log("Messaggio ricevuto:", event.data, "da origine:", event.origin);

      if (event.origin !== 'https://rena.altervista.org') {
        console.log("Messaggio da origine non autorizzata:", event.origin);
        return;
      }

      if (event.data && event.data.status === 'success') {
        console.log("Login successful, salvataggio dati utente");
        localStorage.setItem('user_data', JSON.stringify(event.data));

        updateProfileUI(event.data);
        startTokenVerification();

        document.getElementById('loginPopup').classList.remove('active');
      } else {
        console.log("Login fallito o formato messaggio non valido");
      }
    });

    function showLoginUI() {
      console.log("Mostra UI login");
      const profileButton = document.getElementById('profile-button');
      const accountLink = document.querySelector('.profile-menu-item');

      if (profileButton && accountLink) {
        profileButton.innerHTML = '<div class="default-avatar"><i class="fas fa-user"></i></div>';

        const span = accountLink.querySelector('span');
        if (span) {
          span.setAttribute('data-translate-it', 'Accedi');
          span.setAttribute('data-translate-en', 'Login');
          span.textContent = 'Accedi';
        }

        accountLink.onclick = function (e) {
          e.preventDefault();
          openCrossDomainLogin();
        };

        accountLink.href = "#";
      }
    }
  </script>
</body>

</html>
<!--Start of Tawk.to Script-->
<script type="text/javascript">
var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
(function(){
var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
s1.async=true;
s1.src='https://embed.tawk.to/66b7a281146b7af4a438bd6e/1i4ul5igl';
s1.charset='UTF-8';
s1.setAttribute('crossorigin','*');
s0.parentNode.insertBefore(s1,s0);
})();
</script>
<!--End of Tawk.to Script-->
